@{
    ViewBag.NoCard = true;
    Dictionary<string, object> PageInfo = ViewBag.PageInfo;
}
@section styles{
    <style>
        .propname {
            font-weight: 400;
            text-align: right;
        }

        #page {
            background: white;
            width: 980px;
            border: 1px solid #cfcfcf;
            margin-top: 20px;
            box-sizing: content-box;
        }

        .layui-table td, .layui-table th, .layui-table-col-set, .layui-table-fixed-r, .layui-table-grid-down, .layui-table-header, .layui-table-mend, .layui-table-page, .layui-table-tips-main, .layui-table-tool, .layui-table-total, .layui-table-view, .layui-table[lay-skin=line], .layui-table[lay-skin=row] {
            border-color: black
        }

        .strongt {
            margin-top: 15px;
            display: block;
        }

        .red {
            color: red;
        }

        .redu {
            color: red;
            text-decoration: underline;
        }

        .layui-table tbody tr:hover, .layui-table thead tr, .layui-table-click, .layui-table-header, .layui-table-hover, .layui-table-mend, .layui-table-patch, .layui-table-tool, .layui-table-total, .layui-table-total tr, .layui-table[lay-even] tr:nth-child(even) {
            background-color: transparent;
        }
    </style>
}
@section scripts{
    <script>
        var EnumSex=@JsonHelper.ToJson(EnumConvert.ToList<EnumSex>().ToDictionary(a=>a.Value,a=>a.Text));
    </script>
}
<div class="layui-inline" style="position:fixed;right:100px;top:30px;">
    <button type="button" class="layui-btn layui-btn-lg" lay-on="export">导出</button>
</div>
<div class="layui-container" id="page">

</div>

<form id="downform" target="downframe" action="/TestPlanUser/ExportDetails" method="post" style="display:none">
    <input type="hidden" name="PlanId" value="@(((int?[])PageInfo.G("KeyValues"))[0])" />
    <input type="hidden" name="UserIds[0]" value="@(((int?[])PageInfo.G("KeyValues"))[1])" />
    <button>提交</button>
</form>
<iframe name="downframe" style="display:none"></iframe>

<script type="text/template" id="pageTemplate">
    <div style="padding:20px;line-height:26px">
        {{# var exDic = d.Plan.BusTestPlanExamples.reduce((s,a,i)=>(s[a.ExampleId]=a,s),{}); }}
        {{# d.Plan.BusTestPlanUserExamples = d.Plan.BusTestPlanUserExamples.filter(a=>exDic[a.ExampleId]).sort((a,b)=>(exDic[a.ExampleId].SortNo-exDic[b.ExampleId].SortNo)); }}
        <h1 style="text-align:center;padding:35px 0">爱拜尔PSY心理测评报告</h1>
        <table class="layui-table" style="color:black">
            <tbody>
                <tr>
                    <td>测试名称</td>
                    <td colspan="5">{{d.Plan.Name||"未知"}}</td>
                </tr>
                <tr>
                    <td>题目数</td>
                    <td>{{d.Plan.QuestionNum||"未知"}}</td>
                    <td>完成题数</td>
                    <td>{{d.FinishQuestion||"未知"}}</td>
                    <td>版  本</td>
                    <td>V1.0</td>
                </tr>
                <tr>
                    <td>规定时长</td>
                    <td>{{d.Plan.Template.Duration||"-"}}分钟</td>
                    <td>测评对象</td>
                    <td>{{d.User.BusUserInfoUsers[0].RealName||d.User.Name||d.User.Account||"未知"}}</td>
                    <td>测评人员</td>
                    <td>{{d.Plan.ObjectTag.BusUserInfoUsers[0].RealName||d.Plan.ObjectTag.Name||d.Plan.ObjectTag.Account||"未知"}}</td>
                </tr>
                <tr>
                    <td>实际用时</td>
                    <td>{{Math.round(d.Duration/60)}}分钟</td>
                    <td>页    次</td>
                    <td id="pagenum"></td>
                    <td>报告日期</td>
                    <td>{{d.EndTime?new Date(d.EndTime).format("yyyy.MM.dd"):"-"}}</td>
                </tr>
                <tr>
                    <td>测试时间</td>
                    <td>{{d.BeginTime}}</td>
                    <td>结束时间</td>
                    <td>{{d.EndTime}}</td>
                    <td>完成时间</td>
                    <td>{{d.EndTime}}</td>
                </tr>
                <tr>
                    <td colspan="6" style="line-height:26px">
                        <div></div>
                        <strong class="strongt">说明</strong>
                        <pre style="font-family: inherit; ">{{d.Plan.Template.NContent}}</pre>
                        <strong class="strongt">评价方法</strong>
                        <pre style="font-family: inherit; ">{{d.Plan.Template.Note}}</pre>
                        <strong class="strongt">测试题</strong>
                        {{# layui.each(d.Questions,function(i,a){ }}
                        {{# if(!a.SortNo2){ }}

                        <div style="display: flex; ">
                            <div>{{(i+1)}}.</div>
                            <pre style="display:block;font-family:inherit;flex:1">{{=a.Question.Title}}</pre>
                        </div>
                        {{# if(a.Question.Image){ }}
                        {{# let img=(a.Question.Image||{}).FullName||"/static/photos/cup-of-coffee-on-table-in-cafe-2.jpg"; }}
                        <img style="height:100px;margin:10px auto;display:block;object-fit:cover" src="{{img}}" />
                        {{# } }}
                        <div class="layui-inline" style="margin-bottom: 0;">

                            {{# let myop = d.Plan.BusTestPlanUserOptions.filter(function(b){return b.QuestionId==a.QuestionId;}); }}
                            {{# let mycode=myop.map(function(b){return b.Option.Code;}).join(","); }}
                            {{# if(mycode){ }}
                            <strong style="color:red">（{{mycode}}）</strong>
                            {{# } }}
                        </div>

                        {{# }else if(a.SortNo2==1){ }}

                        <div style="display: flex; ">
                            <div>{{(i+1)}}.</div>
                            <pre style="display:block;font-family:inherit;flex:1">{{=a.Question.NContent}}</pre>
                        </div>
                        {{# if(a.Question.Image){ }}
                        {{# let img=(a.Question.Image||{}).FullName||"/static/photos/cup-of-coffee-on-table-in-cafe-2.jpg"; }}
                        <img style="height:100px;margin:10px auto;display:block;object-fit:cover" src="{{img}}" />
                        {{# } }}
                        <div style="display: flex; ">
                            <div>{{(a.SortNo2)}})</div>
                            <pre style="display:block;font-family:inherit;flex:1">{{=a.Question.Title}}</pre>
                        </div>
                        <div class="layui-inline" style="margin-bottom: 0;">

                            {{# let myop = d.Plan.BusTestPlanUserOptions.filter(function(b){return b.QuestionId==a.QuestionId;}); }}
                            {{# let mycode=myop.map(function(b){return b.Option.Code;}).join(","); }}
                            {{# if(mycode){ }}
                            <strong style="color:red">（{{mycode}})</strong>
                            {{# } }}
                        </div>

                        {{# }else{ }}

                        <div style="display: flex; ">
                            <div>{{(a.SortNo2)}})</div>
                            <pre style="display:block;font-family:inherit;flex:1">{{=a.Question.Title}}</pre>
                        </div>
                        <div class="layui-inline" style="margin-bottom: 0;">
                            {{# let myop = d.Plan.BusTestPlanUserOptions.filter(function(b){return b.QuestionId==a.QuestionId;}); }}
                            {{# let mycode=myop.map(function(b){return b.Option.Code;}).join(","); }}
                            {{# if(mycode){ }}
                            <strong style="color:red">（{{mycode}})</strong>
                            {{# } }}
                        </div>

                        {{# } }}
                        {{# }); }}

                        <strong class="strongt">评价结果</strong>
                        <div>
                            答题：<span class="red">{{d.FinishQuestion||0}}</span>
                            {{# if(d.Plan.BusTestPlanUserExamples.filter(function(a){return a.ResultCode!=null;}).length<=0){ }}
                            <div style="padding:50px;color:#888;text-align:center">暂无结果</div>
                            {{# } }}
                            {{# let resultArr=[]; }}
                            {{# layui.each(d.Plan.BusTestPlanUserExamples,function(i,a){ }}
                            {{# let results = []; }}
                            {{# let scores = []; }}
                            {{# if(a.Result){ }}
                            {{# results.push(a.Result) }}
                            {{# scores.push(a.Score) }}
                            {{# } }}
                            {{# if(a.ResultIds){ }}
                            {{# results=a.ResultIds.split(",").map(function(b){return d.Results.find(function(c){return c.Id==b})}); }}
                            {{# scores=a.Scores.split(","); }}
                            {{# } }}
                            {{# layui.each(results,function(j,result){ }}
                            {{# if(!result) return true; }}
                            {{# let example=d.Plan.Template.BusTestTemplateExamples.find(function(b){return a.ExampleId==b.ExampleId});}}
                            {{# resultArr.push({score:scores[j],result:result}) }}
                            {{# }); }}
                            {{# }); }}

                            {{# layui.each(resultArr,function(i,a){ }}

                            &nbsp;分数{{i+1}}：<span class="redu">{{a.score}}</span>

                            {{# }); }}
                            {{# layui.each(resultArr,function(i,a){ }}

                            <pre style="font-family:inherit">
                            {{a.result.Title}}：{{a.result.NContent}}
                            {{# if(a.result.Image){ }}
                            {{# let img=(a.result.Image||{}).FullName||"/static/photos/cup-of-coffee-on-table-in-cafe-2.jpg"; }}
                            <img style="height:100px;margin:10px auto;display:block;object-fit:cover" src="{{img}}" />
                            {{# } }}
                            </pre>

                            {{# }); }}

                        </div>
                    </td>
                </tr>
                <tr>
                    <td>相关说明</td>
                    <td colspan="5"></td>
                </tr>
                <tr>
                    <td>编制人员</td>
                    <td></td>
                    <td>审核人员</td>
                    <td></td>
                    <td>批准人员</td>
                    <td></td>
                </tr>
                <tr>
                    <td>编制日期</td>
                    <td></td>
                    <td>审核日期</td>
                    <td></td>
                    <td>批准日期</td>
                    <td></td>
                </tr>
            </tbody>
        </table>

    </div>

</script>